import axios from "axios";
import { Address } from "../../../../../../shared/types";
import { getOdoursVicmapResponseSchema } from "./getOdoursVicmapResponseSchema";
import { inferRawOdourData } from "./inferOdoursData/InferRawOdourData";
import { InferredOdoursData } from "./types";
import { createWfsParams } from "../../../../wfsDataToolkit/createWfsParams/createWfsParams";
import { WFS_DATA_URL } from "../../../../wfsDataToolkit/defaults";
import { geocodeAddress } from "../../../../wfsDataToolkit/geocodeAddress/geoCodeAddress";

type Args = {
  address: Address;
};

type Return = {
  odoursData: InferredOdoursData[];
};

const VLR_WFS_URL = WFS_DATA_URL;

export const getOdourData = async ({ address }: Args): Promise<Return> => {
  const { lat, lon } = await geocodeAddress({ address })!;

  const params = createWfsParams({
    lat,
    lon,
    buffer: 0.5,
    typeName: "open-data-platform:vlr_point",
  });

  const response = await axios.get(VLR_WFS_URL, {
    params,
  });

  const parsedVlrResponse = getOdoursVicmapResponseSchema().parse(
    response.data
  );

  const { inferredOdoursData } = await inferRawOdourData({
    features: parsedVlrResponse.features,
  });

  return { odoursData: inferredOdoursData };
};

if (import.meta.main) {
  const { odoursData } = await getOdourData({
    address: {
      addressLine: "Flinders Street Station",
      suburb: "Melbourne",
      state: "VIC",
      postcode: "3000",
    },
  });

  console.log({ odoursData }, { depth: null });
}
